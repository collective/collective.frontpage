dist: trusty
language: python
sudo: false
cache:
  pip: true
  directories:
  - eggs
  - downloads
python:
  - '2.7'
matrix:
  fast_finish: true
install:
  - virtualenv -p `which python` .
  - bin/pip install -r requirements.txt
  - bin/buildout -N buildout:download-cache=downloads code-analysis:return-status-codes=True annotate
  - bin/buildout -N buildout:download-cache=downloads code-analysis:return-status-codes=True

jobs:
  include:
    - stage: code-analysis
      name: "Code Analysis"
      script: bin/code-analysis
    - stage: tests
      name: "Unit Tests"
      script: bin/test
    - stage: tests # same stage as unit tests to run in parallel
      name: "Integration Tests"
      script:
        - export DISPLAY=:99.0
        - sh -e /etc/init.d/xvfb start
        - sleep 3 # give xvfb some time to start
        - firefox -v
        - bin/test --all -t .robot
    - stage: coverage
      name: "Test Coverage"
      script:
        - bin/createcoverage
        - bin/pip install coverage
        - bin/python -m coverage.pickle2json
        - pip install coveralls
        - coveralls
